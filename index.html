<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>参会指导制作台</title>
  <style>
    :root {
      --bg: #f4f7fb;
      --card: #ffffff;
      --line: #d8e2f0;
      --primary: #1c4e80;
      --accent: #2d8fe6;
      --muted: #5c6777;
      --danger: #cb3837;
      font-family: "PingFang SC", "Microsoft YaHei", system-ui, sans-serif;
    }

    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: #0f1a27; }
    button, input, textarea, select { font: inherit; }
    .app { display: grid; grid-template-columns: 320px 1fr; min-height: 100vh; }

    .sidebar {
      border-right: 1px solid var(--line);
      background: var(--card);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      overflow-y: auto;
    }

    h1 { font-size: 20px; margin: 0; color: var(--primary); }
    .hint { color: var(--muted); font-size: 12px; margin: 0; }
    .group { border: 1px solid var(--line); border-radius: 10px; padding: 12px; background: #fafcff; }
    .group h2 { margin: 0 0 10px; font-size: 14px; color: var(--primary); }

    label { display: block; font-size: 12px; margin: 8px 0 4px; color: var(--muted); }
    input, textarea, select {
      width: 100%; border: 1px solid #c7d5e8; border-radius: 8px; padding: 8px; background: #fff;
    }
    textarea { resize: vertical; min-height: 64px; }

    .btns { display: flex; flex-wrap: wrap; gap: 8px; }
    .btn {
      border: none; border-radius: 8px; padding: 8px 10px; cursor: pointer;
      background: var(--primary); color: #fff; font-size: 13px;
    }
    .btn.secondary { background: #eef4fb; color: var(--primary); border: 1px solid #c8dbf2; }
    .btn.danger { background: var(--danger); }

    .workspace { padding: 18px; display: grid; gap: 14px; grid-template-rows: auto auto 1fr; }
    .toolbar, .flow, .detail { background: var(--card); border: 1px solid var(--line); border-radius: 12px; }
    .toolbar { padding: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
    .toolbar strong { color: var(--primary); }

    .flow { padding: 12px; overflow: auto; }
    .flow h3, .detail h3 { margin: 0 0 10px; color: var(--primary); font-size: 16px; }

    .nodes { display: flex; align-items: center; gap: 14px; min-height: 120px; padding: 8px 2px; }
    .node {
      min-width: 170px; border-radius: 10px; border: 2px solid #b9cde5; padding: 10px;
      background: #f9fcff; cursor: pointer;
    }
    .node.active { border-color: var(--accent); box-shadow: 0 0 0 3px #d8ebff; }
    .node small { display: block; color: var(--muted); margin-top: 6px; font-size: 12px; }
    .arrow { font-size: 24px; color: #9ab8d6; }

    .detail { padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { border: 1px solid var(--line); border-radius: 10px; padding: 10px; background: #fbfdff; }
    .list-item { border: 1px dashed #bdd2ea; border-radius: 8px; padding: 8px; margin: 8px 0; background: #fff; }
    .list-item p { margin: 4px 0; font-size: 13px; }
    .jump-link { color: var(--accent); text-decoration: none; }

    .media-preview img, .media-preview video { max-width: 100%; border-radius: 8px; border: 1px solid var(--line); }

    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; }
      .detail { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <h1>参会指导制作台</h1>
      <p class="hint">可制作多个参会指导，支持流程图、Q&A、图文视频、节点关联与跨指导跳转链接。</p>

      <section class="group">
        <h2>指导管理</h2>
        <label for="guideSelect">当前指导</label>
        <select id="guideSelect"></select>
        <label for="guideName">指导名称</label>
        <input id="guideName" placeholder="例如：论坛嘉宾参会指南" />
        <div class="btns" style="margin-top: 8px;">
          <button class="btn" id="saveGuideBtn">保存指导</button>
          <button class="btn secondary" id="newGuideBtn">新建指导</button>
        </div>
      </section>

      <section class="group">
        <h2>流程节点编辑</h2>
        <label for="nodeTitle">节点标题</label>
        <input id="nodeTitle" placeholder="例如：提交报名信息" />
        <label for="nodeDesc">节点说明</label>
        <textarea id="nodeDesc" placeholder="例如：填写姓名、单位、证件等信息"></textarea>
        <label for="linkNode">关联到节点（可选）</label>
        <select id="linkNode"></select>
        <label for="jumpGuide">跳转到其他指导（可选）</label>
        <select id="jumpGuide"></select>
        <div class="btns" style="margin-top: 8px;">
          <button class="btn" id="addNodeBtn">新增节点</button>
          <button class="btn secondary" id="updateNodeBtn">更新当前节点</button>
          <button class="btn danger" id="removeNodeBtn">删除当前节点</button>
        </div>
      </section>

      <section class="group">
        <h2>内容添加</h2>
        <label for="qaQuestion">Q&A - 问题</label>
        <input id="qaQuestion" placeholder="请输入问题" />
        <label for="qaAnswer">Q&A - 答案</label>
        <textarea id="qaAnswer" placeholder="请输入答案"></textarea>
        <button class="btn" id="addQaBtn" style="margin-top:8px;">添加 Q&A 到当前节点</button>

        <label for="mediaType">媒体类型</label>
        <select id="mediaType">
          <option value="image">图片</option>
          <option value="video">视频</option>
          <option value="text">纯文字</option>
        </select>
        <label for="mediaValue">媒体内容（URL 或文本）</label>
        <textarea id="mediaValue" placeholder="图片/视频请填链接，文字可直接输入"></textarea>
        <button class="btn" id="addMediaBtn" style="margin-top:8px;">添加媒体到当前节点</button>
      </section>
    </aside>

    <main class="workspace">
      <section class="toolbar">
        <div>
          <strong id="guideTitle">未选择指导</strong>
          <div class="hint" id="statusText">请先创建一个指导。</div>
        </div>
        <div class="btns">
          <button class="btn secondary" id="exportBtn">导出 JSON</button>
          <button class="btn secondary" id="exportWebBtn">导出网页</button>
          <button class="btn secondary" id="importBtn">导入 JSON</button>
          <button class="btn" id="openTargetBtn">打开节点跳转指导</button>
        </div>
      </section>

      <section class="flow">
        <h3>流程图（点击节点查看详情）</h3>
        <div class="nodes" id="nodesCanvas"></div>
      </section>

      <section class="detail">
        <article class="card">
          <h3>Q&A</h3>
          <div id="qaList"></div>
        </article>
        <article class="card">
          <h3>媒体内容</h3>
          <div id="mediaList" class="media-preview"></div>
        </article>
      </section>
    </main>
  </div>

  <script>
    const STORAGE_KEY = "memberguide_data_v1";
    const uid = () => `${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;

    const state = {
      guides: [],
      currentGuideId: null,
      currentNodeId: null,
    };

    function bootstrap() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        Object.assign(state, JSON.parse(raw));
      }
      if (!state.guides.length) {
        const demoGuide = createGuide("示例参会指导");
        demoGuide.nodes.push(createNode("提交参会申请", "填写嘉宾资料并提交审核"));
        demoGuide.nodes.push(createNode("等待审核", "主办方完成资料审核"));
        demoGuide.nodes.push(createNode("收到确认通知", "短信与邮件双渠道通知"));
        state.guides.push(demoGuide);
        state.currentGuideId = demoGuide.id;
        state.currentNodeId = demoGuide.nodes[0].id;
      }
      ensureCurrentRefs();
      render();
    }

    function createGuide(name) {
      return { id: uid(), name, nodes: [] };
    }

    function createNode(title, description) {
      return {
        id: uid(),
        title,
        description,
        qa: [],
        media: [],
        relationNodeId: "",
        jumpGuideId: "",
      };
    }

    function persist() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function ensureCurrentRefs() {
      const guide = state.guides.find(g => g.id === state.currentGuideId) || state.guides[0];
      state.currentGuideId = guide?.id || null;
      state.currentNodeId = guide?.nodes.find(n => n.id === state.currentNodeId)?.id || guide?.nodes[0]?.id || null;
    }

    function currentGuide() {
      return state.guides.find(g => g.id === state.currentGuideId);
    }

    function currentNode() {
      const guide = currentGuide();
      return guide?.nodes.find(n => n.id === state.currentNodeId);
    }

    function render() {
      ensureCurrentRefs();
      persist();
      renderGuideSelector();
      renderNodeFormOptions();
      renderFlow();
      renderDetails();
      const guide = currentGuide();
      document.getElementById("guideTitle").textContent = guide ? `当前指导：${guide.name}` : "未选择指导";
      document.getElementById("statusText").textContent = guide ? `共 ${guide.nodes.length} 个流程节点` : "请先创建一个指导。";
      document.getElementById("guideName").value = guide?.name || "";
      fillNodeForm();
    }

    function renderGuideSelector() {
      const select = document.getElementById("guideSelect");
      select.innerHTML = state.guides.map(g => `<option value="${g.id}">${g.name}</option>`).join("");
      select.value = state.currentGuideId || "";

      const jump = document.getElementById("jumpGuide");
      const options = ['<option value="">不设置跳转</option>'].concat(state.guides.map(g => `<option value="${g.id}">${g.name}</option>`));
      jump.innerHTML = options.join("");
    }

    function renderNodeFormOptions() {
      const guide = currentGuide();
      const select = document.getElementById("linkNode");
      if (!guide) {
        select.innerHTML = '<option value="">无可关联节点</option>';
        return;
      }
      const opts = ['<option value="">不设置关联</option>'].concat(
        guide.nodes.map(n => `<option value="${n.id}">${n.title}</option>`)
      );
      select.innerHTML = opts.join("");
    }

    function renderFlow() {
      const wrap = document.getElementById("nodesCanvas");
      const guide = currentGuide();
      if (!guide || !guide.nodes.length) {
        wrap.innerHTML = "<p class='hint'>暂无流程节点，请从左侧新增。</p>";
        return;
      }

      wrap.innerHTML = guide.nodes.map((node, idx) => {
        const relation = node.relationNodeId ? `<small>关联节点：${findNodeTitle(guide, node.relationNodeId)}</small>` : "";
        const jump = node.jumpGuideId ? `<small>跳转指导：${findGuideName(node.jumpGuideId)}</small>` : "";
        const arrow = idx < guide.nodes.length - 1 ? "<span class='arrow'>→</span>" : "";
        return `
          <div style="display:flex;align-items:center;gap:14px;">
            <div class="node ${node.id === state.currentNodeId ? "active" : ""}" data-node-id="${node.id}">
              <strong>${node.title}</strong>
              <small>${node.description || "无说明"}</small>
              ${relation}
              ${jump}
            </div>
            ${arrow}
          </div>
        `;
      }).join("");

      wrap.querySelectorAll(".node").forEach(el => {
        el.addEventListener("click", () => {
          state.currentNodeId = el.dataset.nodeId;
          render();
        });
      });
    }

    function renderDetails() {
      const node = currentNode();
      const qaList = document.getElementById("qaList");
      const mediaList = document.getElementById("mediaList");

      if (!node) {
        qaList.innerHTML = "<p class='hint'>请选择节点查看详情。</p>";
        mediaList.innerHTML = "<p class='hint'>请选择节点查看详情。</p>";
        return;
      }

      qaList.innerHTML = node.qa.length ? node.qa.map((item, index) => `
        <div class="list-item">
          <p><strong>Q:</strong> ${item.q}</p>
          <p><strong>A:</strong> ${item.a}</p>
          <div class="btns">
            <button class="btn secondary" data-action="edit-qa" data-index="${index}">编辑</button>
            <button class="btn danger" data-action="delete-qa" data-index="${index}">删除</button>
          </div>
        </div>
      `).join("") : "<p class='hint'>当前节点暂无 Q&A。</p>";

      mediaList.innerHTML = node.media.length ? node.media.map((item, index) => {
        const actions = `
          <div class="btns">
            <button class="btn secondary" data-action="edit-media" data-index="${index}">编辑</button>
            <button class="btn danger" data-action="delete-media" data-index="${index}">删除</button>
          </div>
        `;
        if (item.type === "image") return `<div class='list-item'><p>图片</p><img src="${item.value}" alt="节点图片" />${actions}</div>`;
        if (item.type === "video") return `<div class='list-item'><p>视频</p><video controls src="${item.value}"></video>${actions}</div>`;
        return `<div class='list-item'><p>文字</p><p>${item.value}</p>${actions}</div>`;
      }).join("") : "<p class='hint'>当前节点暂无媒体内容。</p>";

      qaList.querySelectorAll('[data-action="edit-qa"]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const index = Number(btn.dataset.index);
          const target = node.qa[index];
          if (!target) return;
          const q = prompt('编辑问题：', target.q);
          if (q === null) return;
          const a = prompt('编辑答案：', target.a);
          if (a === null) return;
          if (!q.trim() || !a.trim()) return alert('Q 和 A 不能为空');
          target.q = q.trim();
          target.a = a.trim();
          render();
        });
      });

      qaList.querySelectorAll('[data-action="delete-qa"]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const index = Number(btn.dataset.index);
          if (!window.confirm('确认删除该 Q&A 吗？')) return;
          node.qa.splice(index, 1);
          render();
        });
      });

      mediaList.querySelectorAll('[data-action="edit-media"]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const index = Number(btn.dataset.index);
          const target = node.media[index];
          if (!target) return;
          const type = prompt('编辑媒体类型（image/video/text）：', target.type);
          if (type === null) return;
          if (!["image", "video", "text"].includes(type.trim())) return alert('媒体类型仅支持 image/video/text');
          const value = prompt('编辑媒体内容（URL 或文本）：', target.value);
          if (value === null) return;
          if (!value.trim()) return alert('媒体内容不能为空');
          target.type = type.trim();
          target.value = value.trim();
          render();
        });
      });

      mediaList.querySelectorAll('[data-action="delete-media"]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const index = Number(btn.dataset.index);
          if (!window.confirm('确认删除该媒体内容吗？')) return;
          node.media.splice(index, 1);
          render();
        });
      });
    }

    function exportGuideAsWebPage() {
      const guide = currentGuide();
      if (!guide) return alert('请先选择一个指导再导出网页');

      const guideJson = JSON.stringify(guide, null, 2);
      const html = `<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>${guide.name} - 参会指导</title>
  <style>
    body { font-family: "PingFang SC", "Microsoft YaHei", sans-serif; margin: 0; background: #f5f7fb; color: #122033; }
    .container { max-width: 1080px; margin: 0 auto; padding: 20px; }
    h1 { margin: 0 0 8px; color: #1c4e80; }
    .hint { color: #5c6777; margin-bottom: 20px; }
    .card { background: #fff; border: 1px solid #d8e2f0; border-radius: 12px; padding: 14px; margin-bottom: 14px; }
    .qa, .media { border: 1px dashed #bdd2ea; border-radius: 8px; padding: 10px; margin: 8px 0; background: #fbfdff; }
    img, video { max-width: 100%; border-radius: 8px; border: 1px solid #d8e2f0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>${guide.name}</h1>
    <p class="hint">共 ${guide.nodes.length} 个流程节点</p>
    <div id="content"></div>
  </div>
  <script>
    const guide = ${guideJson};
    const root = document.getElementById('content');
    root.innerHTML = guide.nodes.map((node, index) => {
      const qa = (node.qa || []).length
        ? (node.qa || []).map((item) => `<div class="qa"><p><strong>Q:</strong> ${item.q}</p><p><strong>A:</strong> ${item.a}</p></div>`).join('')
        : '<p class="hint">暂无 Q&A</p>';
      const media = (node.media || []).length
        ? (node.media || []).map((item) => {
          if (item.type === 'image') return `<div class="media"><p>图片</p><img src="${item.value}" alt="节点图片" /></div>`;
          if (item.type === 'video') return `<div class="media"><p>视频</p><video controls src="${item.value}"></video></div>`;
          return `<div class="media"><p>文字</p><p>${item.value}</p></div>`;
        }).join('')
        : '<p class="hint">暂无媒体内容</p>';
      return `<section class="card"><h2>${index + 1}. ${node.title}</h2><p>${node.description || ''}</p><h3>Q&A</h3>${qa}<h3>媒体素材</h3>${media}</section>`;
    }).join('');
  </script>
</body>
</html>`;

      const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${guide.name || 'memberguide'}.html`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function fillNodeForm() {
      const node = currentNode();
      document.getElementById("nodeTitle").value = node?.title || "";
      document.getElementById("nodeDesc").value = node?.description || "";
      document.getElementById("linkNode").value = node?.relationNodeId || "";
      document.getElementById("jumpGuide").value = node?.jumpGuideId || "";
    }

    function findGuideName(id) {
      return state.guides.find(g => g.id === id)?.name || "未知指导";
    }

    function findNodeTitle(guide, nodeId) {
      return guide.nodes.find(n => n.id === nodeId)?.title || "未知节点";
    }

    document.getElementById("guideSelect").addEventListener("change", (e) => {
      state.currentGuideId = e.target.value;
      state.currentNodeId = currentGuide()?.nodes[0]?.id || null;
      render();
    });

    document.getElementById("saveGuideBtn").addEventListener("click", () => {
      const guide = currentGuide();
      if (!guide) return;
      const name = document.getElementById("guideName").value.trim();
      if (!name) return alert("指导名称不能为空");
      guide.name = name;
      render();
    });

    document.getElementById("newGuideBtn").addEventListener("click", () => {
      const g = createGuide(`新指导 ${state.guides.length + 1}`);
      g.nodes.push(createNode("开始", "添加你的流程步骤"));
      state.guides.push(g);
      state.currentGuideId = g.id;
      state.currentNodeId = g.nodes[0].id;
      render();
    });

    document.getElementById("addNodeBtn").addEventListener("click", () => {
      const guide = currentGuide();
      if (!guide) return;
      const title = document.getElementById("nodeTitle").value.trim();
      if (!title) return alert("节点标题不能为空");
      const node = createNode(title, document.getElementById("nodeDesc").value.trim());
      node.relationNodeId = document.getElementById("linkNode").value;
      node.jumpGuideId = document.getElementById("jumpGuide").value;
      guide.nodes.push(node);
      state.currentNodeId = node.id;
      render();
    });

    document.getElementById("updateNodeBtn").addEventListener("click", () => {
      const node = currentNode();
      if (!node) return;
      const title = document.getElementById("nodeTitle").value.trim();
      if (!title) return alert("节点标题不能为空");
      node.title = title;
      node.description = document.getElementById("nodeDesc").value.trim();
      node.relationNodeId = document.getElementById("linkNode").value;
      node.jumpGuideId = document.getElementById("jumpGuide").value;
      render();
    });

    document.getElementById("removeNodeBtn").addEventListener("click", () => {
      const guide = currentGuide();
      const node = currentNode();
      if (!guide || !node) return;
      guide.nodes = guide.nodes.filter(n => n.id !== node.id);
      state.currentNodeId = guide.nodes[0]?.id || null;
      render();
    });

    document.getElementById("addQaBtn").addEventListener("click", () => {
      const node = currentNode();
      if (!node) return;
      const q = document.getElementById("qaQuestion").value.trim();
      const a = document.getElementById("qaAnswer").value.trim();
      if (!q || !a) return alert("Q 和 A 不能为空");
      node.qa.push({ q, a });
      document.getElementById("qaQuestion").value = "";
      document.getElementById("qaAnswer").value = "";
      render();
    });

    document.getElementById("addMediaBtn").addEventListener("click", () => {
      const node = currentNode();
      if (!node) return;
      const type = document.getElementById("mediaType").value;
      const value = document.getElementById("mediaValue").value.trim();
      if (!value) return alert("媒体内容不能为空");
      node.media.push({ type, value });
      document.getElementById("mediaValue").value = "";
      render();
    });

    document.getElementById("openTargetBtn").addEventListener("click", () => {
      const node = currentNode();
      if (!node || !node.jumpGuideId) return alert("当前节点未设置跳转指导");
      state.currentGuideId = node.jumpGuideId;
      state.currentNodeId = currentGuide()?.nodes[0]?.id || null;
      render();
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      const content = JSON.stringify(state.guides, null, 2);
      const blob = new Blob([content], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "memberguide-export.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById("exportWebBtn").addEventListener("click", () => {
      exportGuideAsWebPage();
    });

    document.getElementById("importBtn").addEventListener("click", () => {
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json";
      inp.onchange = () => {
        const f = inp.files?.[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            state.guides = JSON.parse(String(reader.result));
            state.currentGuideId = state.guides[0]?.id || null;
            state.currentNodeId = state.guides[0]?.nodes[0]?.id || null;
            render();
          } catch {
            alert("导入失败，JSON 格式有误");
          }
        };
        reader.readAsText(f);
      };
      inp.click();
    });

    bootstrap();
  </script>
</body>
</html>
